#!/bin/bash
# Helper script for mounting user backup directories
# Called via sudo by get_my_files_from, view_my_files_from, release_my_files

ACTION="$1"
MACHINE="$2"
USERNAME="$3"
SUBPATH="$4"

BACKUP_BASE="franksinatra:/mnt/everything/backup-testing"
MOUNT_BASE="/backups"
VALID_MACHINES="aamy adam alexis badenpowell boyi camryn cooper evan hamilton irene2 josh justin kevin khanh mayer michael sarah thais"

# Validate machine name
validate_machine() {
    local machine="$1"
    for valid in $VALID_MACHINES; do
        if [ "$machine" = "$valid" ]; then
            return 0
        fi
    done
    return 1
}

case "$ACTION" in
    mount)
        if [ -z "$MACHINE" ] || [ -z "$USERNAME" ]; then
            echo "Error: Missing machine or username"
            exit 1
        fi
        if ! validate_machine "$MACHINE"; then
            echo "Error: Unknown machine '$MACHINE'"
            echo "Available machines: $VALID_MACHINES"
            exit 1
        fi
        if [ -n "$SUBPATH" ]; then
            MOUNT_POINT="${MOUNT_BASE}/${MACHINE}/${USERNAME}/${SUBPATH}"
            REMOTE_PATH="${BACKUP_BASE}/${MACHINE}/${USERNAME}/${SUBPATH}"
        else
            MOUNT_POINT="${MOUNT_BASE}/${MACHINE}/${USERNAME}"
            REMOTE_PATH="${BACKUP_BASE}/${MACHINE}/${USERNAME}"
        fi
        mkdir -p "$MOUNT_POINT"
        OUTPUT=$(/usr/bin/mount -t nfs -o ro,noexec,nosuid,vers=3 "$REMOTE_PATH" "$MOUNT_POINT" 2>&1)
        MOUNT_EXIT=$?
        echo "$OUTPUT" | grep -v "hint"
        if [ $MOUNT_EXIT -ne 0 ]; then
            rmdir "$MOUNT_POINT" 2>/dev/null
            rmdir "${MOUNT_BASE}/${MACHINE}/${USERNAME}" 2>/dev/null
            rmdir "${MOUNT_BASE}/${MACHINE}" 2>/dev/null
            exit 1
        fi
        ;;
    umount)
        if [ -z "$USERNAME" ]; then
            echo "Error: Missing username"
            exit 1
        fi
        if [ -n "$MACHINE" ]; then
            # Unmount all for specific machine/user
            MOUNTS=$(mount | grep "^franksinatra:/mnt/everything/backup-testing/${MACHINE}/${USERNAME}" | awk '{print $3}')
        else
            # Unmount all for user
            MOUNTS=$(mount | grep "^franksinatra:/mnt/everything/backup-testing/.*/${USERNAME}" | awk '{print $3}')
        fi
        for MOUNT_POINT in $MOUNTS; do
            /usr/bin/umount "$MOUNT_POINT"
            # Clean up empty directories
            while [ "$MOUNT_POINT" != "$MOUNT_BASE" ]; do
                rmdir "$MOUNT_POINT" 2>/dev/null || break
                MOUNT_POINT=$(dirname "$MOUNT_POINT")
            done
        done
        ;;
    list)
        if [ -z "$USERNAME" ]; then
            echo "Error: Missing username"
            exit 1
        fi
        if [ -n "$MACHINE" ]; then
            mount | grep "^franksinatra:/mnt/everything/backup-testing/${MACHINE}/${USERNAME}" | awk '{print $3}'
        else
            mount | grep "^franksinatra:/mnt/everything/backup-testing/.*/${USERNAME}" | awk '{print $3}'
        fi
        ;;
    view)
        if [ -z "$MACHINE" ] || [ -z "$USERNAME" ]; then
            echo "Error: Missing machine or username"
            exit 1
        fi
        if ! validate_machine "$MACHINE"; then
            echo "Error: Unknown machine '$MACHINE'"
            echo "Available machines: $VALID_MACHINES"
            exit 1
        fi
        TEMP_MOUNT="/tmp/backups/${MACHINE}/${USERNAME}"
        mkdir -p "$TEMP_MOUNT"
        OUTPUT=$(/usr/bin/mount -t nfs -o ro,noexec,nosuid,vers=3 "${BACKUP_BASE}/${MACHINE}/${USERNAME}" "$TEMP_MOUNT" 2>&1)
        MOUNT_EXIT=$?
        echo "$OUTPUT" | grep -v "hint"
        if [ $MOUNT_EXIT -eq 0 ]; then
            if [ -n "$SUBPATH" ]; then
                if [ -d "${TEMP_MOUNT}/${SUBPATH}" ]; then
                    ls -la "${TEMP_MOUNT}/${SUBPATH}"
                else
                    echo "Error: Directory '${SUBPATH}' not found"
                fi
            else
                ls -la "$TEMP_MOUNT"
            fi
            /usr/bin/umount "$TEMP_MOUNT"
        fi
        rmdir "$TEMP_MOUNT" 2>/dev/null
        rmdir "/tmp/backups/${MACHINE}" 2>/dev/null
        rmdir "/tmp/backups" 2>/dev/null
        ;;
    *)
        echo "Invalid action"
        exit 1
        ;;
esac
